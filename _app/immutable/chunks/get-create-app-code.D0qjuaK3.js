var f=Object.defineProperty;var d=(n,e,t)=>e in n?f(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var g=(n,e,t)=>(d(n,typeof e!="symbol"?e+"":e,t),t);import{v as validateArgs,B as Box,a as Button,C as Columns,D as Direction,b as Duration,E as EnterNumber,c as EnterText,F as Font,H as Html,L as Layers,P as Paper,d as PaperLine,e as PaperCircle,f as PaperGroup,g as PaperRectangle,R as Rows,S as Space,T as Text,h as Time,U as Updater,r as runUpdater,i as Time$1,j as FrameworkPage,k as PaperFigure,l as PaperComponent}from"./index.Gu5gcrKE.js";class App{onBefore(){}createIcon(){}createStartPage(){}createErrorRecoveringPage(){return this.createStartPage()}}function deepMergeObjects(n,...e){for(const t of e)for(const r in t){const a=t[r];a instanceof Array?n[r]=a:typeof a=="object"&&a!=null&&a!=null?(n[r]||(n[r]={}),deepMergeObjects(n[r],t[r])):n[r]=a}return n}class Page{createBeforeDirections(){return[]}onBefore(){}createGui(){}onAfter(){}createAfterDirections(){return[]}}const m=new class{randomInt(e,t){return validateArgs(this,"randomInt",["number","number"],arguments),Math.floor(this.randomFloat(e,t+1))}randomFloat(e,t){return validateArgs(this,"randomFloat",["number","number"],arguments),Math.random()*(t-e)+e}lowest(...e){const t=Array.from(arguments);return validateArgs(this,"lowest",t.map(r=>"number"),t),Math.min(...e)}highest(...e){const t=Array.from(arguments);return validateArgs(this,"highest",t.map(r=>"number"),t),Math.max(...e)}},speaker=new class{speak(e){validateArgs(this,"speak",["string"],arguments);const t=new SpeechSynthesisUtterance(e);speechSynthesis.speak(t)}speakWithVoice(e,t){validateArgs(this,"speakWithVoice",["string","object"],arguments);const r=new SpeechSynthesisUtterance(e);r.voice=window.speechSynthesis.getVoices().find(a=>a.voiceURI==t.id),r.lang=t.languageCode,r.rate=t.rate,r.pitch=t.pitch,speechSynthesis.speak(r)}getVoices(){return validateArgs(this,"getVoices",[],arguments),speechSynthesis.getVoices().filter(e=>e.localService).map(e=>({id:e.voiceURI,name:e.name,languageCode:e.lang,pitch:1,rate:1}))}getVoicesByLanguageCode(e){return this.getVoices().filter(t=>t.languageCode.includes(e))}};function createPageCreator(n,e){return Object.defineProperty(e,"name",{get(){return n}}),new Proxy(e,{get(r,a,o){switch(a){case"proxyName":return e.name;case"prototype":return e.prototype;default:const i=createRealPageCreator(e);return Reflect.get(i,a,e)}}})}function createRealPageCreator(n){let e={},t="";const r=o=>(e[t]=o,a),a=new Proxy(n,{get(o,i,s){switch(i){case"proxyName":return n.name;case"prototype":return n.prototype;case"proxyClearArgs":e={};return;case"proxyGetPageAndArgs":return{Page:n,args:e};default:return t=i,r}}});return a}function sw(n){const e=new Number(n);return e.unit="vw",e}function evalExpression(jsExpressionAsString){const variables={App,Box,Button,Columns,createPageCreator,Direction,Duration,EnterNumber,EnterText,Font,Html,Layers,m,Page,Paper,PaperLine,PaperCircle,PaperGroup,PaperRectangle,Rows,Space,speaker,sw,Text,Time,Updater,runUpdater},parameters=Object.keys(variables),args=Object.values(variables),code=`
		(function evaluateExpression(${parameters.join(", ")}){ return ${jsExpressionAsString}})
	`.trim(),evaluateExpression=eval(code);return evaluateExpression(...args)}function getCopyWithRestoredClassInstances(n){return n instanceof Array?n.map(getCopyWithRestoredClassInstances):n instanceof Object?n.clazyName==Time$1.name?Time$1.fromJSON(n):Object.fromEntries(Object.entries(n).map(([e,t])=>[e,getCopyWithRestoredClassInstances(t)])):n}const defaultRuntimeSettings={isPreview:!1,onPageShow:()=>{},onError:null,onLog:(n,e)=>{},onStateChange:n=>{},onIconCreated:n=>{},onHardResetRequest:()=>{},state:null,version:1},constantNameRegExp=/^[A-Z0-9_]+$/;class FrameworkApp{constructor(e,t={}){g(this,"createApp",null);g(this,"App",null);g(this,"app",null);g(this,"Pages",{});g(this,"frameworkPage",null);g(this,"pageStates",{});g(this,"errorMessage","");g(this,"runtimeSettings",{});g(this,"intervalIds",[]);g(this,"timeoutIds",[]);const r=t.onError;this.createApp=e,this.runtimeSettings=deepMergeObjects({},defaultRuntimeSettings,t),this.runtimeSettings.onError=a=>{this.errorMessage=a,this.stop(),r==null||r(a)}}start(){this.createClasses(),!this.errorMessage&&(this.runtimeSettings.state?this.runtimeSettings.state.version<this.runtimeSettings.version?this.update():this.restoreFromState():this.startFromScratch())}startFromScratch(){const{onLog:e,onError:t}=this.runtimeSettings;try{e("framework",`Initializing variables in ${this.App.name}...`),this.app=new this.App}catch(a){t(`Error ocurred while initializing variables in ${this.App.name}: ${a}.`);return}if(e("framework",`Initializing variables in ${this.App.name}... ✅`),this.runCreateIcon(),this.runOnBefore(),this.errorMessage)return;const r=this.runCreateStartPage();r&&this.loadPage(r)}createClasses(){var i;const{onError:e,onLog:t}=this.runtimeSettings;if(typeof this.createApp=="string"){try{t("framework","Parsing the code..."),this.createApp=evalExpression(this.createApp)}catch(s){e(`Code parsing failed: ${s}.`);return}t("framework","Parsing the code... ✅")}const r=this,a={a:new Proxy({},{get(s,p,c){return Reflect.get(r.app,p,r.app)},set(s,p,c,h){return Reflect.set(r.app,p,c,r.app)},ownKeys(s){return Reflect.ownKeys(r.app)},getOwnPropertyDescriptor(s,p){return Reflect.getOwnPropertyDescriptor(r.app,p)}}),p:new Proxy({},{get(s,p,c){return Reflect.get(r.frameworkPage.page,p,r.frameworkPage.page)},set(s,p,c,h){return Reflect.set(r.frameworkPage.page,p,c,r.frameworkPage.page)},ownKeys(s){return Reflect.ownKeys(r.frameworkPage.page)},getOwnPropertyDescriptor(s,p){return Reflect.getOwnPropertyDescriptor(r.frameworkPage.page,p)}}),log(s){t("user",JSON.stringify(s,null,"  "))},setInterval:(...s)=>{const[p,c,...h]=s,u=()=>{try{p(...h)}catch(l){this.runtimeSettings.onError(`Error occurred when calling function passed to setInterval(): ${l}`)}};if(!this.runtimeSettings.isPreview){const l=setInterval(u,c,...h);return this.intervalIds.push(l),l}},setTimeout:(...s)=>{const[p,c,...h]=s,u=()=>{try{p(...h)}catch(l){this.runtimeSettings.onError(`Error occurred when calling function passed to setTimeout(): ${l}`)}};if(!this.runtimeSettings.isPreview){const l=setTimeout(u,c,...h);return this.timeoutIds.push(l),l}}};let o;try{t("framework","Creating classes..."),o=this.createApp(a)}catch(s){e(`Error when creating classes: ${s}.`);return}if(!(((i=o==null?void 0:o.App)==null?void 0:i.prototype)instanceof App)){e("Error: Your own App class must inherit from the App class that comes from BagaWork.");return}t("framework","Creating classes... ✅"),this.App=o.App,this.Pages=o.Pages}runOnBefore(){const{onError:e,onLog:t}=this.runtimeSettings;if(this.App.prototype.hasOwnProperty("onBefore"))try{t("framework",`Calling ${this.App.name}.onBefore()...`),this.app.onBefore(),t("framework",`Calling ${this.App.name}.onBefore()... ✅`)}catch(r){e(`Error in ${this.App.name}.onBefore(): ${r}.`);return}}update(){const{version:e,state:t,onLog:r,onError:a}=this.runtimeSettings;r("framework",`Update from version ${t.version} to version ${e} detected!`);try{r("framework",`Initializing variables in ${this.App.name}...`),this.app=new this.App,r("framework",`Initializing variables in ${this.App.name}... ✅`)}catch(s){a(`Error ocurred while initializing variables in ${this.App.name}: ${s}.`);return}r("framework","Copying over values in app variables that exist in both versions from the old version to the new version...");const o=getCopyWithRestoredClassInstances(t.app);let i=null;for(const s of Object.keys(o))this.app.hasOwnProperty(s)&&(constantNameRegExp.test(s)||(this.app[s]=o[s]));r("framework","Copying over values in app variables that exist in both versions from the old version to the new version... ✅"),i=this.runOnUpdate(),!this.errorMessage&&(this.updatePages(),!(!i&&!this.Pages.hasOwnProperty(t.currentPageName)&&(i=this.runCreateStartPage(),this.errorMessage))&&(this.runCreateIcon(),!this.errorMessage&&(this.frameworkPage=new FrameworkPage(this,i??this.Pages[t.currentPageName]),this.frameworkPage.loadFromState(),this.runtimeSettings.onStateChange(this.getState()))))}runOnUpdate(){const{onError:e,onLog:t}=this.runtimeSettings;let r=null;if(this.App.prototype.hasOwnProperty("onUpdate")){try{t("framework",`Calling ${this.App.name}.onUpdate()...`),r=this.app.onUpdate(this.runtimeSettings.state.app,this.runtimeSettings.state.version),t("framework",`Calling${this.App.name}.onUpdate()... ✅`)}catch(a){e(`Error in ${this.App.name}.onUpdate(): ${a}.`);return}if(r&&!(r instanceof Page)){e(`Error in ${this.App.name}.onUpdate(): If returning a value, it must be a class inheriting from Page.`);return}}return r}updatePages(){const{state:e,onLog:t}=this.runtimeSettings;for(const r of Object.keys(e.pages))if(this.Pages.hasOwnProperty(r)){this.pageStates[r]={},t("framework",`Copying over values in page variables that exist in both versions from the old version to the new version in ${r}...`),this.frameworkPage=new FrameworkPage(this,this.Pages[r]),this.frameworkPage.page=new this.frameworkPage.Page;const{page:a}=this.frameworkPage;for(const o of Object.keys(e.pages[r]))a.hasOwnProperty(o)&&(constantNameRegExp.test(o)||(a[o]=e.pages[r][o]));t("framework",`Copying over values in page variables that exist in both versions from the old version to the new version in ${r}... ✅`),this.frameworkPage.runOnUpdate(),this.frameworkPage.rememberState()}}restoreFromState(){const{state:e,onLog:t,onError:r}=this.runtimeSettings;t("framework","Restoring app and page variables from state... ✅");try{this.app=Object.setPrototypeOf({},this.App.prototype),Object.assign(this.app,getCopyWithRestoredClassInstances(e.app)),this.pageStates=getCopyWithRestoredClassInstances(e.pages)}catch(a){r(`Error occurred when trying to restore the state: ${a}`);return}this.frameworkPage=new FrameworkPage(this,this.Pages[e.currentPageName]),this.frameworkPage.loadFromState(),this.runCreateIcon(),!this.errorMessage&&this.runtimeSettings.onStateChange(this.getState())}runCreateStartPage(){const{onLog:e,onError:t}=this.runtimeSettings;if(!this.App.prototype.hasOwnProperty("createStartPage")){t(`Error: ${this.App.name}.createStartPage() is missing.`);return}let r;try{e("framework",`Calling ${this.App.name}.createStartPage()...`),r=this.app.createStartPage()}catch(a){t(`Error in ${this.App.name}.createStartPage(): ${a}.`);return}if(!r){t(`Error in ${this.App.name}.createStartPage(): Does currently not return a value at all. Must return a class that inherits from the Page class that comes from BagaWork.`);return}if(!(r.prototype instanceof Page)){t(`Error in ${this.App.name}.createStartPage(): The returned value must be a class that inherits from the Page class that comes from BagaWork.`);return}return e("framework",`Calling ${this.App.name}.createStartPage()... ✅`),e("framework",`(note: when previewing a page in the editor, ${this.App.name}.createStartPage() is overwritten to always return the page you are previewing, and not the one you have actually specified in ${this.App.name}.createStartPage())`),r}runCreateErrorRecoveringPage(){const{onLog:e,onError:t}=this.runtimeSettings;let r=null;if(!this.App.prototype.hasOwnProperty("createErrorRecoveringPage"))e("framework",`${this.App.name}.createErrorRecoveringPage() doesn't exist, so uses ${this.App.name}.createStartPage() instead.`),r=this.runCreateStartPage();else{try{e("framework",`Calling ${this.App.name}.createErrorRecoveringPage()...`),r=this.app.createErrorRecoveringPage()}catch(a){t(`Error in ${this.App.name}.createErrorRecoveringPage(): ${a}.`);return}if(!r){t(`Error in ${this.App.name}.createErrorRecoveringPage(): Does currently not return a value at all. Must return a class that inherits from the Page class that comes from BagaWork.`);return}if(!(r.prototype instanceof Page)){t(`Error in ${this.App.name}.createErrorRecoveringPage(): The returned value must be a class that inherits from the Page class that comes from BagaWork.`);return}e("framework",`Calling ${this.App.name}.createErrorRecoveringPage()... ✅`)}return r}loadPage(e){const{onLog:t}=this.runtimeSettings;if(this.frameworkPage=new FrameworkPage(this,e),this.frameworkPage.createPageInstance(),this.frameworkPage.createBeforeDirections(),!this.runtimeSettings.isPreview){const r=this.frameworkPage.getFirstTrueBeforeDirection();if(r){const a=r.getPage();t("framework",`Got a true before direction leading to ${a.proxyName}.`),this.loadPage(a);return}}this.frameworkPage.runOnBefore(),this.runtimeSettings.onStateChange(this.getState()),this.frameworkPage.initializeTheRest()}moveOn(){const{onLog:e}=this.runtimeSettings;this.stop(),this.frameworkPage.runOnAfter(),this.frameworkPage.refreshAfterDirections();const t=this.frameworkPage.getFirstTrueAfterDirection();if(this.frameworkPage.rememberState(),t){const r=t.getPage();e("framework",`Got a true after direction leading to ${r.proxyName}.`),this.loadPage(t.getPage())}else e("framework","Got no true after direction, so reloads the current page."),this.frameworkPage.Page.proxyClearArgs,this.loadPage(this.frameworkPage.Page)}stop(){var e,t;(t=(e=this.frameworkPage)==null?void 0:e.stopUpdaters)==null||t.call(e),this.stopAndClearTimeoutsAndIntervals()}stopAndClearTimeoutsAndIntervals(){for(const e of this.timeoutIds)clearTimeout(e);this.timeoutIds=[];for(const e of this.intervalIds)clearInterval(e);this.intervalIds=[]}getState(){return this.frameworkPage.rememberState(),JSON.parse(JSON.stringify({version:this.runtimeSettings.version,currentPageName:this.frameworkPage.Page.proxyName,app:this.app,pages:this.pageStates}))}runCreateIcon(){const{onLog:e,onError:t}=this.runtimeSettings;if(!this.App.prototype.hasOwnProperty("createIcon"))return;let r=null;try{e("framework",`Calling ${this.App.name}.createIcon()...`),r=this.app.createIcon()}catch(o){t(`Error in ${this.App.name}.createIcon(): ${o}.`);return}if(!r){t(`Error in ${this.App.name}.createIcon(): Does currently not return a value at all. Must return an instance of a paper figure that comes from BagaWork.`);return}if(!(r instanceof PaperFigure)){t(`Error in ${this.App.name}.createIcon(): The returned value must be an instance of a paper figure that comes from BagaWork.`);return}e("framework",`Calling ${this.App.name}.createIcon()... ✅`);const a=new PaperComponent;a.children(r),this.runtimeSettings.onIconCreated(a.getAsSvgString())}createElement(){const e=document.createElement("div");e.classList.add("app"),e.style.all="initial",e.style.boxSizing="border-box",e.style.display="block",e.style.height="100%",e.style.backgroundColor="white",e.style.fontSize="16px",this.runtimeSettings.isPreview&&e.setAttribute("inert","");const t=()=>{if(e.innerHTML="",this.errorMessage){const a=document.createElement("div");a.style.boxSizing="border-box",a.style.padding="1em",a.style.height="100%",a.style.overflow="auto",a.innerHTML=`
					<h1 style="margin: 0;">Error! 😭</h1>
					
					<p>Oh, no... The following error occurred in the app:</p>
					
					<blockquote style="font-style: italic;"></blockquote>
					
					<p>We are truly sorry for this. Hopefully we can take the app back to a state where it will run again, but the same error will probably still occur until the developer of the app has fixed the problem. So if clicking the button below takes you back here, you can wait until the developer of the app has released a new version of it that doesn't contain the problem, and then clicking on the button below will hopefully make the app work fine again 😃</p>
					
					<button>
						Try to make the app run again
					</button>
					
					<p>You also have the option to do a hard reset. A hard reset means that you delete all the data in the app, and then you start running it from scratch again. But if you do this, all your progress in the app will be lost. So only do this if you can live with that.</p>
					
					<button>
						Delete all data and start the app from scratch
					</button>
					
				`,a.querySelector("blockquote").innerText=this.errorMessage,a.querySelectorAll("button")[0].addEventListener("click",()=>{this.errorMessage="";let o=null;try{o=this.runCreateErrorRecoveringPage()}catch{const s=document.createElement("p");s.innerText="Nope, sorry, that didn't work 🙁",a.replaceChild(s,a.querySelectorAll("button")[0]);return}this.loadPage(o),t()}),a.querySelectorAll("button")[1].addEventListener("click",()=>{this.runtimeSettings.onHardResetRequest()}),e.replaceChildren(a);return}try{const a=this.frameworkPage.createElement();this.errorMessage||e.replaceChildren(a)}catch(a){this.errorMessage=a,t()}};e.addEventListener("moveon",()=>{this.moveOn(),t()});const r=this.runtimeSettings.onError;return this.runtimeSettings.onError=a=>{r(a),t()},t(),e}}async function showAppInElement(n,e,t={}){await new Promise((i,s)=>{0<window.speechSynthesis.getVoices().length?i():window.speechSynthesis.addEventListener("voiceschanged",i)});const r={...t};let a=null;r.onHardResetRequest=()=>{delete r.state,a=o()},a=o();function o(){const i=new FrameworkApp(n,r);return i.start(),e.shadowRoot||e.attachShadow({mode:"open"}),e.shadowRoot.replaceChildren(i.createElement()),i}return function(){a.stop()}}function getClassName(n){return cachedGetClassName(n)}function realGetClassName(n){const e=n.match(new RegExp("(?<=class )\\w+(?= extends)"));return e==null||!e[0]?"UnknownClassName":e[0]}const cache=new Map;function cachedGetClassName(n){const e=cache.get(n);if(e)return e;const t=realGetClassName(n);return cache.set(n,t),t}function getPageCodeWithPageCreator(n){const e=getClassName(n);return`const ${e} = createPageCreator(
		'${e}',
		${n.replace(/^class\s+[^\s]+/,"class")}
		)`}function getCreateAppCode(n,e,t=null,r=!1){const a=t?getClassName(t.code):"",o=e.map(c=>getClassName(c.code)),i=e.map(c=>getPageCodeWithPageCreator(r&&c!=t?`class ${getClassName(c.code)} extends Page{ }`:c.code));if(t&&!e.includes(t)){const c=o.findIndex(h=>h==a);c!=-1?i[c]=getPageCodeWithPageCreator(t.code):(o.push(a),i.push(getPageCodeWithPageCreator(t.code)))}const s=t?n.code.replace(/\}\s*$/,`createStartPage(){ return ${a} } }`):n.code;return`
function createApp({a, p, log, setInterval, setTimeout}){
	
	${i.join(`

`)}
	
	return {
		App: (${s}),
		Pages: {
			${o.join(", ")}
		}
	}
	
}
	`.trim()}export{FrameworkApp as F,getClassName as a,getCreateAppCode as g,showAppInElement as s};
